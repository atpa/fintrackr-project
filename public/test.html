<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FinTrackr ‚Äì Test Page (No SW)</title>
    <link rel="stylesheet" href="css/style.css" />
    <style>
      .test-container {
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }
      .test-result {
        margin: 10px 0;
        padding: 10px;
        border-radius: 4px;
        background: #f0f0f0;
      }
      .test-result.pass {
        background: #d4edda;
        color: #155724;
      }
      .test-result.fail {
        background: #f8d7da;
        color: #721c24;
      }
      .test-result.info {
        background: #d1ecf1;
        color: #0c5460;
      }
      .btn-test {
        padding: 10px 20px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
        font-size: 14px;
      }
      .btn-test:hover {
        background: #0056b3;
      }
      .btn-test.danger {
        background: #dc3545;
      }
      .btn-test.danger:hover {
        background: #c82333;
      }
      .btn-test.success {
        background: #28a745;
      }
      .btn-test.success:hover {
        background: #218838;
      }
      code {
        background: #f4f4f4;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
      }
    </style>
  </head>
  <body>
    <div class="test-container">
      <h1>üß™ FinTrackr Test Page</h1>
      <div class="test-result info">
        <strong>‚ÑπÔ∏è –≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ë–ï–ó Service Worker</strong><br>
        Service Worker –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∫ <code>/test.html</code> –∏ <code>/test-auth.html</code>
      </div>
      
      <h2>Service Worker Control</h2>
      <button class="btn-test danger" onclick="unregisterSW()">üóëÔ∏è Unregister SW</button>
      <button class="btn-test danger" onclick="clearAllCaches()">üßπ Clear All Caches</button>
      <button class="btn-test success" onclick="registerSW()">‚úÖ Register SW</button>
      <button class="btn-test" onclick="checkSWStatus()">üîç Check SW Status</button>
      <div id="sw-control-results"></div>
      
      <h2>API Tests</h2>
      <button class="btn-test" onclick="testAccounts()">üìä Test /api/accounts</button>
      <button class="btn-test" onclick="testRates()">üí± Test /api/rates</button>
      <button class="btn-test" onclick="testDashboard()">üìÑ Test /dashboard.html</button>
      <button class="btn-test" onclick="runAllTests()">‚ñ∂Ô∏è Run All Tests</button>
      <div id="results"></div>
      
      <h2>Navigation</h2>
      <ul>
        <li><a href="/" target="_blank">–ì–ª–∞–≤–Ω–∞—è (index.html)</a></li>
        <li><a href="/dashboard.html" target="_blank">Dashboard</a></li>
        <li><a href="/login.html" target="_blank">Login</a></li>
        <li><a href="/transactions.html" target="_blank">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</a></li>
        <li><a href="/accounts.html" target="_blank">–°—á–µ—Ç–∞</a></li>
      </ul>
      
      <h2>System Information</h2>
      <div id="system-info" class="test-result info">
        <strong>üñ•Ô∏è –°–µ—Ä–≤–µ—Ä:</strong> <span id="server-status">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span><br>
        <strong>‚öôÔ∏è Service Worker:</strong> <span id="sw-status">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span><br>
        <strong>üì± PWA Manifest:</strong> <span id="manifest-status">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span><br>
        <strong>üåê Online:</strong> <span id="online-status">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
      </div>
    </div>
    
    <script>
      const resultsDiv = document.getElementById('results');
      const swControlDiv = document.getElementById('sw-control-results');
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
      window.addEventListener('load', () => {
        checkSystemStatus();
        checkSWStatus();
      });
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã
      async function checkSystemStatus() {
        // Online status
        document.getElementById('online-status').textContent = navigator.onLine ? '‚úÖ Online' : '‚ùå Offline';
        
        // Server status
        try {
          const response = await fetch('/api/accounts');
          document.getElementById('server-status').textContent = response.ok ? '‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç' : '‚ùå –û—à–∏–±–∫–∞';
        } catch {
          document.getElementById('server-status').textContent = '‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
        }
        
        // Manifest status
        try {
          const response = await fetch('/manifest.json');
          document.getElementById('manifest-status').textContent = response.ok ? '‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω' : '‚ùå –û—à–∏–±–∫–∞';
        } catch {
          document.getElementById('manifest-status').textContent = '‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
        }
      }
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ Service Worker
      async function checkSWStatus() {
        if (!('serviceWorker' in navigator)) {
          document.getElementById('sw-status').textContent = '‚ùå Not supported';
          return;
        }
        
        const registration = await navigator.serviceWorker.getRegistration();
        if (registration) {
          document.getElementById('sw-status').textContent = `‚úÖ Registered (${registration.active ? 'Active' : 'Installing'})`;
        } else {
          document.getElementById('sw-status').textContent = '‚ö™ Not registered';
        }
      }
      
      // SW Control Functions
      async function unregisterSW() {
        swControlDiv.innerHTML = '';
        if (!('serviceWorker' in navigator)) {
          addSWResult('Unregister SW', 'fail', 'Service Worker not supported');
          return;
        }
        
        try {
          const registration = await navigator.serviceWorker.getRegistration();
          if (registration) {
            await registration.unregister();
            addSWResult('Unregister SW', 'pass', '‚úÖ Service Worker unregistered');
          } else {
            addSWResult('Unregister SW', 'info', 'No Service Worker registered');
          }
          checkSWStatus();
        } catch (error) {
          addSWResult('Unregister SW', 'fail', `‚ùå ${error.message}`);
        }
      }
      
      async function clearAllCaches() {
        swControlDiv.innerHTML = '';
        try {
          const cacheNames = await caches.keys();
          await Promise.all(cacheNames.map(name => caches.delete(name)));
          addSWResult('Clear Caches', 'pass', `‚úÖ Cleared ${cacheNames.length} caches`);
        } catch (error) {
          addSWResult('Clear Caches', 'fail', `‚ùå ${error.message}`);
        }
      }
      
      async function registerSW() {
        swControlDiv.innerHTML = '';
        if (!('serviceWorker' in navigator)) {
          addSWResult('Register SW', 'fail', 'Service Worker not supported');
          return;
        }
        
        try {
          const registration = await navigator.serviceWorker.register('/sw.js', { scope: '/' });
          addSWResult('Register SW', 'pass', '‚úÖ Service Worker registered');
          checkSWStatus();
        } catch (error) {
          addSWResult('Register SW', 'fail', `‚ùå ${error.message}`);
        }
      }
      
      function addSWResult(test, status, message) {
        const div = document.createElement('div');
        div.className = `test-result ${status}`;
        div.innerHTML = `<strong>${test}:</strong> ${message}`;
        swControlDiv.appendChild(div);
      }
      
      // Test Functions
      function addResult(test, status, message) {
        const div = document.createElement('div');
        div.className = `test-result ${status}`;
        div.innerHTML = `<strong>${test}:</strong> ${message}`;
        resultsDiv.appendChild(div);
      }
      
      async function testAccounts() {
        resultsDiv.innerHTML = '';
        try {
          const response = await fetch('/api/accounts');
          const data = await response.json();
          addResult('GET /api/accounts', 'pass', `‚úÖ OK - ${data.length} —Å—á–µ—Ç–æ–≤`);
        } catch (error) {
          addResult('GET /api/accounts', 'fail', `‚ùå ${error.message}`);
        }
      }
      
      async function testRates() {
        try {
          const response = await fetch('/api/rates?base=USD&quote=EUR');
          const data = await response.json();
          addResult('GET /api/rates', 'pass', `‚úÖ OK - rate: ${data.rate}`);
        } catch (error) {
          addResult('GET /api/rates', 'fail', `‚ùå ${error.message}`);
        }
      }
      
      async function testDashboard() {
        try {
          const response = await fetch('/dashboard.html');
          const ok = response.ok;
          addResult('GET /dashboard.html', ok ? 'pass' : 'fail', 
            ok ? '‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–æ—Å—Ç—É–ø–Ω–∞' : `‚ùå –û—à–∏–±–∫–∞ ${response.status}`);
        } catch (error) {
          addResult('GET /dashboard.html', 'fail', `‚ùå ${error.message}`);
        }
      }
      
      async function runAllTests() {
        resultsDiv.innerHTML = '<div class="test-result info">‚è≥ Running all tests...</div>';
        await new Promise(r => setTimeout(r, 500));
        resultsDiv.innerHTML = '';
        await testAccounts();
        await testRates();
        await testDashboard();
        addResult('All Tests', 'pass', '‚úÖ Tests completed');
      }
      
      // Network status monitoring
      window.addEventListener('online', () => {
        document.getElementById('online-status').textContent = '‚úÖ Online';
        checkSystemStatus();
      });
      
      window.addEventListener('offline', () => {
        document.getElementById('online-status').textContent = '‚ùå Offline';
      });
    </script>
  </body>
</html>
