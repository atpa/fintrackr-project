import{i as t}from"./chunks/navigation-BNxy9xC7.js";import{i as e}from"./chunks/profile-BfLkpaKJ.js";import{A as n}from"./chunks/api-BDCGX8nm.js";import{t as a,a as o}from"./chunks/Toast-Cw3r9-oW.js";import{c}from"./chunks/ModalBase-nBdty8ot.js";function d(t,e,n,a,o=!1){const c=document.createElement("tr"),d=document.createElement("td");d.textContent=t.date;const i=document.createElement("td"),r=e.find(e=>e.id===t.account_id);i.textContent=r?r.name:"—";const s=document.createElement("td"),l=n.find(e=>e.id===t.category_id);s.textContent=l?l.name:"—";const m=document.createElement("td");m.textContent="income"===t.type?"Доход":"Расход",m.className="income"===t.type?"status-income":"status-expense";const u=document.createElement("td");u.textContent=Number(t.amount).toFixed(2)+" "+t.currency,u.className="income"===t.type?"status-income":"status-expense";const y=document.createElement("td");y.textContent=t.note||"";const p=document.createElement("td"),g=document.createElement("button");g.className="btn-secondary tx-del",g.setAttribute("data-id",t.id),g.textContent="Удалить",p.appendChild(g),c.append(d,i,s,m,u,y,p),o&&a.firstChild?a.prepend(c):a.appendChild(c)}async function i(){const t=document.querySelector("#transactionsTable tbody");if(t)try{let e=function(e){if(t.innerHTML="",!e.length){const e=document.createElement("tr"),n=document.createElement("td");return n.colSpan=7,n.textContent="Нет операций",e.appendChild(n),void t.appendChild(e)}e.sort((t,e)=>new Date(e.date)-new Date(t.date)),e.forEach(e=>d(e,r,s,t))};const[i,r,s,l]=await Promise.all([n.transactions.getAll(),n.accounts.getAll(),n.categories.getAll(),n.rules.getAll()]);window.autoRules=Array.isArray(l)?l:[],window.allTransactions=Array.isArray(i)?i.slice():[];const m=document.getElementById("txAccount"),u=document.getElementById("txCategory");m&&(m.innerHTML="",r.forEach(t=>{const e=document.createElement("option");e.value=t.id,e.textContent=t.name,m.appendChild(e)})),u&&(u.innerHTML="",s.forEach(t=>{const e=document.createElement("option");e.value=t.id,e.textContent=t.name,u.appendChild(e)})),e(window.allTransactions);const y=document.getElementById("addTransactionForm");y&&y.addEventListener("submit",async e=>{e.preventDefault();const c=document.getElementById("txDate"),i=document.getElementById("txAmount"),l={account_id:Number(m.value),category_id:Number(u.value),type:document.getElementById("txType").value,amount:parseFloat(document.getElementById("txAmount").value),currency:document.getElementById("txCurrency").value,date:document.getElementById("txDate").value,note:document.getElementById("txNote").value};if(!l.date)return c.setCustomValidity("Укажите дату операции"),c.reportValidity(),void setTimeout(()=>c.setCustomValidity(""),1500);if(!isFinite(l.amount)||l.amount<0)return i.setCustomValidity("Введите корректную сумму (0 или больше)"),i.reportValidity(),void setTimeout(()=>i.setCustomValidity(""),1500);if(l.note){const t=l.note.toLowerCase();for(const e of window.autoRules||[])if(t.includes(e.keyword)){l.category_id=Number(e.category_id);break}}try{const e=await n.transactions.create(l);window.allTransactions.unshift(e),d(e,r,s,t,!0),r.forEach(t=>{if(t.id===e.account_id){const n="function"==typeof convertAmount?convertAmount(Number(e.amount),e.currency||"USD",t.currency||"USD"):Number(e.amount);"income"===e.type?t.balance+=n:t.balance-=n}}),a("Операция добавлена"),y.reset()}catch(p){o(`Не удалось добавить операцию: ${p.message}`)}});const p=document.getElementById("filterTxForm");if(p){p.addEventListener("submit",t=>{t.preventDefault();const n=document.getElementById("filterStart").value,a=document.getElementById("filterEnd").value,o=document.getElementById("filterCategory").value,c=document.getElementById("filterType").value,d=window.allTransactions.filter(t=>{let e=!0;return n&&(e=e&&new Date(t.date)>=new Date(n)),a&&(e=e&&new Date(t.date)<=new Date(a)),o&&(e=e&&String(t.category_id)===String(o)),c&&(e=e&&t.type===c),e});e(d)});const t=document.getElementById("filterCategory");t&&t.options.length<=1&&s.forEach(e=>{const n=document.createElement("option");n.value=e.id,n.textContent=e.name,t.appendChild(n)})}t.addEventListener("click",async t=>{const d=t.target.closest(".tx-del");if(!d)return;const i=d.getAttribute("data-id");if(!i)return;if(await c({title:"Удалить операцию?",message:"Это действие нельзя отменить",danger:!0}))try{await n.transactions.delete(i),a("Операция удалена"),window.allTransactions=(window.allTransactions||[]).filter(t=>String(t.id)!==String(i)),e(window.allTransactions)}catch(r){o(`Не удалось удалить операцию: ${r.message}`)}})}catch(e){o(`Не удалось загрузить данные: ${e.message}`)}}t(),e(),"loading"!==document.readyState?i():document.addEventListener("DOMContentLoaded",i);
