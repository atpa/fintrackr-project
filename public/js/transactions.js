import{f as C}from"./api-D6s1A7e-.js";import{i as v}from"./navigation-BDLIzq93.js";import{i as b}from"./profile-BEROGLl0.js";v();b();function T(r,g,f,s,w=!1){const l=document.createElement("tr"),u=document.createElement("td");u.textContent=r.date;const y=document.createElement("td"),p=g.find(i=>i.id===r.account_id);y.textContent=p?p.name:"—";const E=document.createElement("td"),n=f.find(i=>i.id===r.category_id);E.textContent=n?n.name:"—";const t=document.createElement("td");t.textContent=r.type==="income"?"Доход":"Расход",t.className=r.type==="income"?"status-income":"status-expense";const e=document.createElement("td");e.textContent=Number(r.amount).toFixed(2)+" "+r.currency,e.className=r.type==="income"?"status-income":"status-expense";const o=document.createElement("td");o.textContent=r.note||"";const c=document.createElement("td"),a=document.createElement("button");a.className="btn-secondary tx-del",a.setAttribute("data-id",r.id),a.textContent="Удалить",c.appendChild(a),l.append(u,y,E,t,e,o,c),w&&s.firstChild?s.prepend(l):s.appendChild(l)}async function h(){const r=document.querySelector("#transactionsTable tbody");if(!r)return;const[g,f,s,w]=await Promise.all([C("/api/transactions"),C("/api/accounts"),C("/api/categories"),C("/api/rules")]);window.autoRules=Array.isArray(w)?w:[],window.allTransactions=Array.isArray(g)?g.slice():[];const l=document.getElementById("txAccount"),u=document.getElementById("txCategory");l&&(l.innerHTML="",f.forEach(n=>{const t=document.createElement("option");t.value=n.id,t.textContent=n.name,l.appendChild(t)})),u&&(u.innerHTML="",s.forEach(n=>{const t=document.createElement("option");t.value=n.id,t.textContent=n.name,u.appendChild(t)}));function y(n){if(r.innerHTML="",!n.length){const t=document.createElement("tr"),e=document.createElement("td");e.colSpan=7,e.textContent="Нет операций",t.appendChild(e),r.appendChild(t);return}n.sort((t,e)=>new Date(e.date)-new Date(t.date)),n.forEach(t=>T(t,f,s,r))}y(window.allTransactions);const p=document.getElementById("addTransactionForm");p&&p.addEventListener("submit",async n=>{n.preventDefault();const t=document.getElementById("txDate"),e=document.getElementById("txAmount"),o={account_id:Number(l.value),category_id:Number(u.value),type:document.getElementById("txType").value,amount:parseFloat(document.getElementById("txAmount").value),currency:document.getElementById("txCurrency").value,date:document.getElementById("txDate").value,note:document.getElementById("txNote").value};if(!o.date){t.setCustomValidity("Укажите дату операции"),t.reportValidity(),setTimeout(()=>t.setCustomValidity(""),1500);return}if(!isFinite(o.amount)||o.amount<0){e.setCustomValidity("Введите корректную сумму (0 или больше)"),e.reportValidity(),setTimeout(()=>e.setCustomValidity(""),1500);return}if(o.note){const c=o.note.toLowerCase();for(const a of window.autoRules||[])if(c.includes(a.keyword)){o.category_id=Number(a.category_id);break}}try{const c=await fetch("/api/transactions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!c.ok){const i=await c.json();alert("Ошибка: "+(i.error||"не удалось добавить операцию"));return}const a=await c.json();window.allTransactions.unshift(a),T(a,f,s,r,!0),f.forEach(i=>{if(i.id===a.account_id){const m=typeof convertAmount=="function"?convertAmount(Number(a.amount),a.currency||"USD",i.currency||"USD"):Number(a.amount);a.type==="income"?i.balance+=m:i.balance-=m}}),p.reset()}catch(c){console.error(c),alert("Ошибка сети")}});const E=document.getElementById("filterTxForm");if(E){E.addEventListener("submit",t=>{t.preventDefault();const e=document.getElementById("filterStart").value,o=document.getElementById("filterEnd").value,c=document.getElementById("filterCategory").value,a=document.getElementById("filterType").value,i=window.allTransactions.filter(m=>{let d=!0;return e&&(d=d&&new Date(m.date)>=new Date(e)),o&&(d=d&&new Date(m.date)<=new Date(o)),c&&(d=d&&String(m.category_id)===String(c)),a&&(d=d&&m.type===a),d});y(i)});const n=document.getElementById("filterCategory");n&&n.options.length<=1&&s.forEach(t=>{const e=document.createElement("option");e.value=t.id,e.textContent=t.name,n.appendChild(e)})}r.addEventListener("click",async n=>{const t=n.target.closest(".tx-del");if(!t)return;const e=t.getAttribute("data-id");if(e&&confirm("Удалить операцию?"))try{const o=await fetch(`/api/transactions/${e}`,{method:"DELETE"});if(!o.ok){const c=await o.json().catch(()=>({}));alert("Ошибка: "+(c.error||"не удалось удалить операцию"));return}window.allTransactions=(window.allTransactions||[]).filter(c=>String(c.id)!==String(e)),y(window.allTransactions)}catch(o){console.error(o),alert("Ошибка сети")}})}document.readyState!=="loading"?h():document.addEventListener("DOMContentLoaded",h);
