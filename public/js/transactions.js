import{i as h,f as C,p as I,d as b}from"./profile-DStBtrFs.js";import{i as B}from"./navigation-BDLIzq93.js";B();h();function T(o,g,m,d,E=!1){const s=document.createElement("tr"),u=document.createElement("td");u.textContent=o.date;const y=document.createElement("td"),f=g.find(l=>l.id===o.account_id);y.textContent=f?f.name:"—";const p=document.createElement("td"),n=m.find(l=>l.id===o.category_id);p.textContent=n?n.name:"—";const t=document.createElement("td");t.textContent=o.type==="income"?"Доход":"Расход",t.className=o.type==="income"?"status-income":"status-expense";const e=document.createElement("td");e.textContent=Number(o.amount).toFixed(2)+" "+o.currency,e.className=o.type==="income"?"status-income":"status-expense";const a=document.createElement("td");a.textContent=o.note||"";const c=document.createElement("td"),r=document.createElement("button");r.className="btn-secondary tx-del",r.setAttribute("data-id",o.id),r.textContent="Удалить",c.appendChild(r),s.append(u,y,p,t,e,a,c),E&&d.firstChild?d.prepend(s):d.appendChild(s)}async function v(){const o=document.querySelector("#transactionsTable tbody");if(!o)return;const[g,m,d,E]=await Promise.all([C("/api/transactions"),C("/api/accounts"),C("/api/categories"),C("/api/rules")]);window.autoRules=Array.isArray(E)?E:[],window.allTransactions=Array.isArray(g)?g.slice():[];const s=document.getElementById("txAccount"),u=document.getElementById("txCategory");s&&(s.innerHTML="",m.forEach(n=>{const t=document.createElement("option");t.value=n.id,t.textContent=n.name,s.appendChild(t)})),u&&(u.innerHTML="",d.forEach(n=>{const t=document.createElement("option");t.value=n.id,t.textContent=n.name,u.appendChild(t)}));function y(n){if(o.innerHTML="",!n.length){const t=document.createElement("tr"),e=document.createElement("td");e.colSpan=7,e.textContent="Нет операций",t.appendChild(e),o.appendChild(t);return}n.sort((t,e)=>new Date(e.date)-new Date(t.date)),n.forEach(t=>T(t,m,d,o))}y(window.allTransactions);const f=document.getElementById("addTransactionForm");f&&f.addEventListener("submit",async n=>{n.preventDefault();const t=document.getElementById("txDate"),e=document.getElementById("txAmount"),a={account_id:Number(s.value),category_id:Number(u.value),type:document.getElementById("txType").value,amount:parseFloat(document.getElementById("txAmount").value),currency:document.getElementById("txCurrency").value,date:document.getElementById("txDate").value,note:document.getElementById("txNote").value};if(!a.date){t.setCustomValidity("Укажите дату операции"),t.reportValidity(),setTimeout(()=>t.setCustomValidity(""),1500);return}if(!isFinite(a.amount)||a.amount<0){e.setCustomValidity("Введите корректную сумму (0 или больше)"),e.reportValidity(),setTimeout(()=>e.setCustomValidity(""),1500);return}if(a.note){const c=a.note.toLowerCase();for(const r of window.autoRules||[])if(c.includes(r.keyword)){a.category_id=Number(r.category_id);break}}try{const c=await I("/api/transactions",a);window.allTransactions.unshift(c),T(c,m,d,o,!0),m.forEach(r=>{if(r.id===c.account_id){const l=typeof convertAmount=="function"?convertAmount(Number(c.amount),c.currency||"USD",r.currency||"USD"):Number(c.amount);c.type==="income"?r.balance+=l:r.balance-=l}}),f.reset()}catch(c){console.error(c),alert("Ошибка сети")}});const p=document.getElementById("filterTxForm");if(p){p.addEventListener("submit",t=>{t.preventDefault();const e=document.getElementById("filterStart").value,a=document.getElementById("filterEnd").value,c=document.getElementById("filterCategory").value,r=document.getElementById("filterType").value,l=window.allTransactions.filter(w=>{let i=!0;return e&&(i=i&&new Date(w.date)>=new Date(e)),a&&(i=i&&new Date(w.date)<=new Date(a)),c&&(i=i&&String(w.category_id)===String(c)),r&&(i=i&&w.type===r),i});y(l)});const n=document.getElementById("filterCategory");n&&n.options.length<=1&&d.forEach(t=>{const e=document.createElement("option");e.value=t.id,e.textContent=t.name,n.appendChild(e)})}o.addEventListener("click",async n=>{const t=n.target.closest(".tx-del");if(!t)return;const e=t.getAttribute("data-id");if(e&&confirm("Удалить операцию?"))try{await b(`/api/transactions/${e}`),window.allTransactions=(window.allTransactions||[]).filter(a=>String(a.id)!==String(e)),y(window.allTransactions)}catch(a){console.error(a),alert("Ошибка сети")}})}document.readyState!=="loading"?v():document.addEventListener("DOMContentLoaded",v);
