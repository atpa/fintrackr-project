const y=new Set(["GET","HEAD","OPTIONS"]),p=3e4;let f=null,m=0,l=null,w=null;function E(e){w=typeof e=="function"?e:null}async function g(e=!1){return!e&&f&&Date.now()<m-5e3?f:(l&&!e||(l=(async()=>{const t=await fetch("/api/csrf-token",{method:"GET",credentials:"include",headers:{Accept:"application/json","Cache-Control":"no-cache"}});if(!t.ok)throw l=null,new Error("Unable to fetch CSRF token");const n=await t.json();return f=n.csrfToken,m=Date.now()+(Number(n.expiresIn)||0),l=null,f})().catch(t=>{throw l=null,f=null,m=0,t})),l)}function S(e=!1){return g(e)}async function T(e){return e.status===204||!(e.headers.get("content-type")||"").includes("application/json")?null:e.json()}async function _(e,t={},n=p){const r=new AbortController,o=setTimeout(()=>r.abort(),n);try{const s=await fetch(e,{...t,signal:r.signal});return clearTimeout(o),s}catch(s){if(clearTimeout(o),s.name==="AbortError"){const i=new Error("Request timeout");throw i.status=408,i.code="REQUEST_TIMEOUT",i}throw s}}async function d(e,t={}){const n=(t.method||"GET").toUpperCase(),r=t.timeout||p,o={Accept:"application/json",...t.headers||{}},s={method:n,credentials:"include",headers:o};n==="GET"&&(s.cache="no-store"),t.data!==void 0&&(o["Content-Type"]=o["Content-Type"]||"application/json",s.body=o["Content-Type"]==="application/json"?JSON.stringify(t.data):t.data);const i=t.csrf!==!1&&!y.has(n);if(i){const a=await g();o["X-CSRF-Token"]=a}const c=await _(e,s,r);if(!c.ok){let a=null;try{a=await c.json()}catch{a=null}const u=new Error((a==null?void 0:a.error)||`HTTP ${c.status}: ${c.statusText}`);if(u.status=c.status,u.statusCode=c.status,u.code=a==null?void 0:a.code,u.details=a||void 0,i&&a&&typeof a.code=="string"&&a.code.startsWith("CSRF_")&&t._retry!==!1)return await g(!0),d(e,{...t,_retry:!1});throw c.status===401&&w&&w({endpoint:e,method:n,error:u}),u}return T(c)}function O(e,t={}){return d(e,{...t,method:"GET"})}function U(e,t,n={}){return d(e,{...n,method:"POST",data:t})}function R(e,t={}){return d(e,{...t,method:"DELETE"})}const C=new Set(["landing.html","index.html","login.html","register.html","features.html","benefits.html","about.html","premium.html","education.html"]),k=new Set(["GET","HEAD","OPTIONS"]);function A(e){if(typeof window>"u")return!1;let t;try{typeof e=="string"?t=new URL(e,window.location.origin):e instanceof Request?t=new URL(e.url):t=new URL(String(e),window.location.origin)}catch{return!1}return t.origin!==window.location.origin||!t.pathname.startsWith("/api/")?!1:!["/api/login","/api/register","/api/refresh"].includes(t.pathname)}const h={USER_KEY:"user",THEME_KEY:"ft_theme",_cache:null,_sessionPromise:null,_storage(){try{return window.sessionStorage}catch(e){return console.error("Auth: sessionStorage недоступен",e),null}},_readUserFromStorage(){const e=this._storage();if(!e)return null;try{const t=e.getItem(this.USER_KEY);return t?JSON.parse(t):null}catch(t){return console.error("Auth: ошибка чтения пользователя из sessionStorage",t),null}},_writeUserToStorage(e){const t=this._storage();if(t)try{e?t.setItem(this.USER_KEY,JSON.stringify(e)):t.removeItem(this.USER_KEY)}catch(n){console.error("Auth: ошибка записи пользователя в sessionStorage",n)}},isLoggedIn(){return!!this.getUser()},getUser(){if(this._cache)return this._cache;const e=this._readUserFromStorage();return e&&(this._cache=e),e},setUser(e){return!e||!e.email?(console.warn("Auth: нельзя сохранить пустого пользователя"),!1):(this._cache=e,this._writeUserToStorage(e),!0)},login(e){const t=(e==null?void 0:e.user)||e;return this.setUser(t)},clearUser(){this._cache=null,this._writeUserToStorage(null)},requiresAuth(e){const t=(e||this._currentPage()).toLowerCase();return!C.has(t)},_currentPage(){return(window.location.pathname.split("/").pop()||"index.html").toLowerCase()},async syncSession(e=!1){if(!e){const t=this.getUser();if(t)return t}return this._sessionPromise&&!e?this._sessionPromise:(this._sessionPromise=(async()=>{const t=await fetch("/api/session",{method:"GET",credentials:"include",headers:{Accept:"application/json","Cache-Control":"no-cache"}});if(!t.ok)throw new Error("Unauthenticated");const n=await t.json();if(n!=null&&n.user)return this.setUser(n.user),n.user;throw new Error("Session payload is empty")})().catch(t=>{throw this.clearUser(),t}).finally(()=>{this._sessionPromise=null}),this._sessionPromise)},async requireAuth(){try{return await this.syncSession()}catch(e){throw this.handleUnauthorized(),e}},async logout(){try{await U("/api/logout",{},{csrf:!0})}catch(e){console.warn("Auth: ошибка выхода",e)}finally{this.clearUser()}return!0},handleUnauthorized(){this.clearUser();const e=this._currentPage();this.requiresAuth(e)&&(window.location.href="login.html")},getTheme(){try{return localStorage.getItem(this.THEME_KEY)||"light"}catch{return"light"}},setTheme(e){try{localStorage.setItem(this.THEME_KEY,e)}catch(t){console.error("Auth: ошибка смены темы",t)}}};E(()=>h.handleUnauthorized());if(typeof window<"u"&&window.fetch&&!window.__fintrackrFetchWrapped){const e=window.fetch.bind(window);window.fetch=async(t,n={})=>{const r={...n};r.credentials=r.credentials||"include";const o=(r.method||"GET").toUpperCase();if(!k.has(o)&&A(typeof t=="string"?t:t.url)){const i=new Headers(r.headers||{});if(!i.has("X-CSRF-Token")){const c=await S();i.set("X-CSRF-Token",c)}r.headers=i}return e(t,r)},window.__fintrackrFetchWrapped=!0}const I=new Set(["landing.html","index.html","login.html","register.html","features.html","benefits.html","about.html","premium.html","education.html"]);function L(){return(window.location.pathname.split("/").pop()||""||"index.html").toLowerCase()}function P(e){const t=document.querySelector(".profile-name"),n=document.querySelector(".profile-email");t&&(t.textContent=(e==null?void 0:e.name)||"Пользователь"),n&&(n.textContent=(e==null?void 0:e.email)||"")}async function D(e,t){const n=document.querySelector(".login-link"),r=document.querySelector(".register-link"),o=document.querySelector(".logout-link");e?(n&&(n.style.display="none"),r&&(r.style.display="none"),o&&(o.style.display="inline-block",o.addEventListener("click",async s=>{s.preventDefault(),await h.logout(),window.location.href=t},{once:!0}))):(o&&(o.style.display="none"),n&&(n.style.display="inline-block"),r&&(r.style.display="inline-block"))}async function b({requireAuth:e=!0,loginPath:t="login.html",logoutRedirect:n="landing.html",publicPages:r=I}={}){const o=L(),s=r.has(o);try{e&&!s?await h.requireAuth():await h.syncSession().catch(()=>null)}catch{if(e&&!s){window.location.href=t;return}}const i=h.getUser();P(i),await D(i,n)}function q(e={}){const t=()=>{b(e)};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t,{once:!0}):t()}function j(e="settings"){try{const t=localStorage.getItem(e);return t?JSON.parse(t):{}}catch(t){return console.error("Не удалось прочитать настройки профиля",t),{}}}function v(e,t="settings"){try{return localStorage.setItem(t,JSON.stringify(e)),!0}catch(n){return console.error("Не удалось сохранить настройки профиля",n),!1}}function x({settings:e={},nameInput:t=document.getElementById("profileName"),currencySelect:n=document.getElementById("profileCurrency"),timezoneSelect:r=document.getElementById("profileTimezone"),reportCurrencySelect:o=document.getElementById("reportCurrencySelect"),balanceCurrencySelect:s=document.getElementById("balanceCurrencySelect")}={}){const i=h.getUser()||{};t&&(t.value=e.name||i.name||""),n&&(n.value=e.currency||"USD"),r&&(r.value=e.timezone||"Europe/Warsaw"),o&&(o.value=e.reportCurrency||e.currency||"USD"),s&&(s.value=e.balanceCurrency||e.currency||"USD")}export{h as A,x as a,R as d,O as f,q as i,j as l,U as p,v as s};
