import{i as E,p as f,f as y,d as $}from"./profile-DStBtrFs.js";import{i as h}from"./navigation-BDLIzq93.js";h();E();async function k(){try{return await y("/api/banks")}catch(n){return console.error("Не удалось загрузить банки",n),[]}}async function w(){try{return await y("/api/accounts")}catch(n){return console.error("Не удалось загрузить счета",n),[]}}async function u(){try{return await y("/api/sync/connections")}catch(n){return console.error("Не удалось загрузить подключения",n),[]}}function m(n){const a=document.getElementById("connectionsList"),o=document.getElementById("syncResult");if(!a)return;if(!n||n.length===0){a.innerHTML="<p>Нет подключённых банков.</p>";return}const i=n.map(e=>`
        <div style="display:flex; align-items:center; justify-content:space-between; gap:1rem; background:#fff; padding:0.75rem 1rem; border-radius:8px; box-shadow:0 2px 6px var(--card-shadow); margin-bottom:0.5rem;">
          <div>
            <strong>${e.bank_name}</strong><br />
            <small>Счёт ID ${e.account_id||"-"}</small>
          </div>
          <div>
            <button class="btn-secondary" data-sync-id="${e.id}">Синхронизировать</button>
            <button class="btn-link" data-remove-id="${e.id}">Удалить</button>
          </div>
        </div>`).join("");a.innerHTML=i,a.querySelectorAll("button[data-sync-id]").forEach(e=>{e.addEventListener("click",async d=>{const r=Number(d.currentTarget.getAttribute("data-sync-id"));if(r){o&&(o.textContent="Синхронизация...");try{const t=await f("/api/sync/transactions",{connection_id:r});let s=`<p><strong>Синхронизировано операций:</strong> ${t.synced}</p>`;Array.isArray(t.transactions)&&t.transactions.length&&(s+="<p>Полученные операции:</p><ul>",t.transactions.forEach(c=>{s+=`<li>${c.date}: ${c.type==="income"?"+":"-"}${c.amount.toFixed(2)} ${c.currency} (${c.description})</li>`}),s+="</ul>"),o.innerHTML=s}catch(t){console.error(t),o.textContent=t.message||"Ошибка синхронизации"}}})}),a.querySelectorAll("button[data-remove-id]").forEach(e=>{e.addEventListener("click",async d=>{const r=Number(d.currentTarget.getAttribute("data-remove-id"));if(r&&confirm("Удалить подключение?"))try{await $(`/api/sync/connections/${r}`);const t=await u();m(t)}catch(t){alert(t.message||"Не удалось удалить подключение")}})})}async function p(){const n=document.getElementById("bankSelect"),a=document.getElementById("accountSelect"),o=document.getElementById("connectForm"),i=document.getElementById("syncResult"),[e,d,r]=await Promise.all([k(),w(),u()]);n&&(n.innerHTML=e.map(t=>`<option value="${t.id}">${t.name}</option>`).join("")),a&&(a.innerHTML=d.map(t=>`<option value="${t.id}">${t.name} (${t.currency})</option>`).join("")),m(r),o&&o.addEventListener("submit",async t=>{t.preventDefault(),i&&(i.textContent="");const s=Number(n.value),c=Number(a.value),g=document.getElementById("bankLogin").value,b=document.getElementById("bankPassword").value;try{const l=await f("/api/sync/connect",{bank_id:s,account_id:c,login:g,password:b});o.reset(),i.textContent=`Банк ${l.bank_name} подключён к счёту ID ${l.account_id}.`;const v=await u();m(v)}catch(l){i.textContent=l.message||"Не удалось подключить банк"}})}document.readyState!=="loading"?p():document.addEventListener("DOMContentLoaded",p);
