import{i as h}from"./navigation-BDLIzq93.js";import{i as w}from"./profile-BEROGLl0.js";h();w();async function k(){try{const t=await fetch("/api/banks");return t.ok?await t.json():[]}catch(t){return console.error("Ошибка загрузки банков",t),[]}}async function v(){try{const t=await fetch("/api/accounts");return t.ok?await t.json():[]}catch(t){return console.error("Ошибка загрузки счетов",t),[]}}async function y(){try{const t=await fetch("/api/sync/connections");return t.ok?await t.json():[]}catch(t){return console.error("Ошибка загрузки подключений",t),[]}}function p(t){const o=document.getElementById("connectionsList"),e=document.getElementById("syncResult");if(!o)return;if(!t||t.length===0){o.innerHTML="<p>Нет подключённых банковских аккаунтов.</p>";return}const a=t.map(c=>`
        <div style="display:flex; align-items:center; justify-content:space-between; gap:1rem; background:#fff; padding:0.75rem 1rem; border-radius:8px; box-shadow:0 2px 6px var(--card-shadow); margin-bottom:0.5rem;">
          <div>
            <strong>${c.bank_name}</strong><br />
            <small>Счёт ID ${c.account_id}</small>
          </div>
          <button class="btn-secondary" data-sync-id="${c.id}">Синхронизировать</button>
        </div>
      `).join("");o.innerHTML=a,o.querySelectorAll("button[data-sync-id]").forEach(c=>{c.addEventListener("click",async u=>{const d=Number(u.currentTarget.getAttribute("data-sync-id"));if(d){e&&(e.textContent="Синхронизация...");try{const n=await fetch("/api/sync/transactions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({connection_id:d})}),r=await n.json();if(!n.ok){e.textContent=r.error||r.message||"Ошибка синхронизации";return}let i=`<p><strong>Синхронизировано транзакций:</strong> ${r.synced}</p>`;r.transactions&&r.transactions.length&&(i+="<p>Добавленные транзакции:</p><ul>",r.transactions.forEach(s=>{i+=`<li>${s.date}: ${s.type==="income"?"+":"-"}${s.amount.toFixed(2)} ${s.currency} (Категория ID ${s.category_id||"—"})</li>`}),i+="</ul>",i+="<p>Проверьте раздел “Операции” для просмотра новых трат.</p>"),e.innerHTML=i}catch(n){console.error(n),e.textContent="Ошибка сети"}}})})}async function f(){try{if(!localStorage.getItem("user")){window.location.href="login.html";return}}catch{}const t=document.getElementById("bankSelect"),o=document.getElementById("accountSelect"),e=document.getElementById("connectForm"),a=document.getElementById("syncResult"),[c,u,d]=await Promise.all([k(),v(),y()]);t&&(t.innerHTML=c.map(n=>`<option value="${n.id}">${n.name}</option>`).join("")),o&&(o.innerHTML=u.map(n=>`<option value="${n.id}">${n.name} (${n.currency})</option>`).join("")),p(d),e&&e.addEventListener("submit",async n=>{n.preventDefault(),a&&(a.textContent="");const r=Number(t.value),i=Number(o.value),s=document.getElementById("bankLogin").value,g=document.getElementById("bankPassword").value;try{const l=await fetch("/api/sync/connect",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({bank_id:r,account_id:i,login:s,password:g})}),m=await l.json();if(!l.ok){a.textContent=m.error||"Не удалось подключить банк";return}e.reset();const b=await y();p(b),a.textContent=`Банк ${m.bank_name} подключён к счёту ID ${m.account_id}.`}catch(l){console.error(l),a.textContent="Ошибка сети"}})}document.readyState!=="loading"?f():document.addEventListener("DOMContentLoaded",f);
