import{i as n}from"./chunks/navigation-BNxy9xC7.js";import{i as t}from"./chunks/profile-BfLkpaKJ.js";import{A as e}from"./chunks/api-BDCGX8nm.js";import{t as a,a as o}from"./chunks/Toast-Cw3r9-oW.js";async function c(){try{return await e.sync.getBanks()}catch(n){return o(`Не удалось загрузить банки: ${n.message}`),[]}}async function s(){try{return await e.accounts.getAll()}catch(n){return o(`Не удалось загрузить счета: ${n.message}`),[]}}async function r(){try{return await e.sync.getConnections()}catch(n){return o(`Не удалось загрузить подключения: ${n.message}`),[]}}function i(n){const t=document.getElementById("connectionsList"),c=document.getElementById("syncResult");if(!t)return;if(!n||0===n.length)return void(t.innerHTML="<p>Нет подключённых банковских аккаунтов.</p>");const s=n.map(n=>`\n        <div style="display:flex; align-items:center; justify-content:space-between; gap:1rem; background:#fff; padding:0.75rem 1rem; border-radius:8px; box-shadow:0 2px 6px var(--card-shadow); margin-bottom:0.5rem;">\n          <div>\n            <strong>${n.bank_name}</strong><br />\n            <small>Счёт ID ${n.account_id}</small>\n          </div>\n          <button class="btn-secondary" data-sync-id="${n.id}">Синхронизировать</button>\n        </div>\n      `).join("");t.innerHTML=s,t.querySelectorAll("button[data-sync-id]").forEach(n=>{n.addEventListener("click",async n=>{const t=Number(n.currentTarget.getAttribute("data-sync-id"));if(t){c&&(c.textContent="Синхронизация...");try{const n=await e.sync.syncTransactions(t);a(`Синхронизировано транзакций: ${n.synced}`);let o=`<p><strong>Синхронизировано транзакций:</strong> ${n.synced}</p>`;n.transactions&&n.transactions.length&&(o+="<p>Добавленные транзакции:</p><ul>",n.transactions.forEach(n=>{o+=`<li>${n.date}: ${"income"===n.type?"+":"-"}${n.amount.toFixed(2)} ${n.currency} (Категория ID ${n.category_id||"—"})</li>`}),o+="</ul>",o+="<p>Проверьте раздел “Операции” для просмотра новых трат.</p>"),c.innerHTML=o}catch(s){c.textContent="Ошибка синхронизации",o(`Не удалось синхронизировать: ${s.message}`)}}})})}async function d(){try{if(!localStorage.getItem("user"))return void(window.location.href="login.html")}catch(g){}const n=document.getElementById("bankSelect"),t=document.getElementById("accountSelect"),d=document.getElementById("connectForm"),u=document.getElementById("syncResult"),[m,l,y]=await Promise.all([c(),s(),r()]);n&&(n.innerHTML=m.map(n=>`<option value="${n.id}">${n.name}</option>`).join("")),t&&(t.innerHTML=l.map(n=>`<option value="${n.id}">${n.name} (${n.currency})</option>`).join("")),i(y),d&&d.addEventListener("submit",async c=>{c.preventDefault(),u&&(u.textContent="");const s=Number(n.value),m=Number(t.value),l=document.getElementById("bankLogin").value,y=document.getElementById("bankPassword").value;try{const n=await e.sync.connect({bank_id:s,account_id:m,login:l,password:y});a(`Банк ${n.bank_name} подключён к счёту`),d.reset();i(await r()),u.textContent=`Банк ${n.bank_name} подключён к счёту ID ${n.account_id}.`}catch(g){u.textContent="Ошибка подключения",o(`Не удалось подключить банк: ${g.message}`)}})}n(),t(),"loading"!==document.readyState?d():document.addEventListener("DOMContentLoaded",d);
