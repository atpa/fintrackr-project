import{f as U}from"./api-Cdk2p__r.js";import{i as N}from"./navigation-BDLIzq93.js";import{i as k,l as L}from"./profile-BEROGLl0.js";const w={USD:{USD:1,EUR:.94,PLN:4.5,RUB:90},EUR:{USD:1.06,EUR:1,PLN:4.8,RUB:95},PLN:{USD:.22,EUR:.21,PLN:1,RUB:20},RUB:{USD:.011,EUR:.0105,PLN:.05,RUB:1}};function M(){const e=L();return e.reportCurrency||e.currency||"USD"}function A(){const e=L();return e.balanceCurrency||e.reportCurrency||e.currency||"USD"}function b(e,r,c){if(r===c)return Number(e)||0;const n=w[r];return n&&n[c]?Number(e)*n[c]:Number(e)||0}function F(e,r,c){const n=e.getContext("2d"),l=e.width,g=e.height,p=getComputedStyle(document.documentElement),C=p.getPropertyValue("--primary-light").trim()||"#3b82f6",h=p.getPropertyValue("--text").trim()||"#1a202c",f=Math.max(...c,1),s=l/r.length*.6,d=l/r.length*.2;n.font="12px sans-serif";let m=0;const E=r.length<=3?80:120;function I(u,y){if(u.length<=y)return[u];const t=u.split(/\s+/);if(t.length===1){const i=Math.ceil(u.length/2);return[u.slice(0,i),u.slice(i)]}const a=[];let o="";return t.forEach(i=>{(o+" "+i).trim().length<=y?o=(o+" "+i).trim():(o&&a.push(o),o=i)}),o&&a.push(o),a}function S(){m=Math.min(m+.03,1),n.clearRect(0,0,l,g),r.forEach((u,y)=>{const a=c[y]/f*(g-E-20)*m,o=y*(l/r.length)+d,i=g-a-E;n.fillStyle=C,n.fillRect(o,i,s,a),n.fillStyle=h,n.textAlign="center";const x=I(u,10),P=g-E+20;x.forEach((D,R)=>{n.fillText(D,o+s/2,P+R*14)}),m>.95&&n.fillText(c[y].toFixed(0),o+s/2,i-5)}),m<1&&requestAnimationFrame(S)}S()}function v(e,r,c){if(!e)return;const n=e.getContext("2d"),l=c.reduce((d,m)=>d+m,0),g=Math.min(e.width,e.height)/2-20,p=e.width/2,C=e.height/2,h=getComputedStyle(document.documentElement),f=[h.getPropertyValue("--primary").trim(),h.getPropertyValue("--primary-light").trim(),h.getPropertyValue("--accent").trim(),h.getPropertyValue("--danger").trim(),"#1e8f5e","#e0a96d","#b55c4a","#ff8c66","#a64b4a","#e0a96d"];let s=-Math.PI/2;for(let d=0;d<c.length;d++){const m=c[d],E=l?m/l*Math.PI*2:0,I=s+E;n.beginPath(),n.moveTo(p,C),n.arc(p,C,g,s,I),n.closePath(),n.fillStyle=f[d%f.length]||"#ccc",n.fill(),s=I}}async function V(){try{if(!localStorage.getItem("user")){window.location.href="login.html";return}}catch{}const e=await U("/api/transactions"),r=await U("/api/categories"),c=M(),n=A(),l=new Map;e.forEach(t=>{if(t.type==="expense"){const a=r.find(P=>P.id===t.category_id),o=a?a.name:"Неизвестно",i=l.get(o)||0,x=b(Number(t.amount),t.currency||"USD",c);l.set(o,i+x)}});const g=Array.from(l.keys()),p=Array.from(l.values()),C=document.getElementById("expenseChart");C&&F(C,g,p);const h=document.getElementById("expensePie");h&&v(h,g,p);const f=document.getElementById("topCategories");if(f){const t=Array.from(l.entries()).sort((o,i)=>i[1]-o[1]);if(f.innerHTML="",t.slice(0,5).forEach(([o,i])=>{const x=document.createElement("li");x.textContent=`${o}: ${i.toFixed(2)} ${c}`,f.appendChild(x)}),!t.length){const o=document.createElement("li");o.textContent="Нет данных",f.appendChild(o)}}let s=0,d=0;e.forEach(t=>{const a=b(Number(t.amount),t.currency||"USD",n);t.type==="income"?s+=a:t.type==="expense"&&(d+=a)});const m=document.getElementById("totalBalance"),E=document.getElementById("totalIncome"),I=document.getElementById("totalExpense");m&&(m.textContent=(s-d).toFixed(2)),E&&(E.textContent=s.toFixed(2)),I&&(I.textContent=d.toFixed(2));try{document.querySelectorAll(".currency-code").forEach(t=>{t.textContent=n})}catch{}const S=s>0?Math.max((s-d)/s,0):0,u=document.getElementById("financialHealth"),y=document.getElementById("healthProgress");u&&(u.textContent=(S*100).toFixed(0)+"%"),y&&(y.style.width=(S*100).toFixed(0)+"%");try{const t=await U("/api/forecast"),a=document.getElementById("aiIncome"),o=document.getElementById("aiExpense");if(t&&a&&o){const i=b(Number(t.predicted_income||0),"USD",n),x=b(Number(t.predicted_expense||0),"USD",n);a.textContent=i.toFixed(2),o.textContent=x.toFixed(2)}}catch(t){console.error("Ошибка загрузки AI‑прогноза",t)}}N();k();const B=()=>{document.getElementById("expenseChart")&&V()};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",B):B();(function(){if(document.querySelector(".theme-toggle"))return;try{localStorage.getItem("ft_theme")==="dark"&&(document.documentElement.classList.add("dark"),document.body.classList.add("dark"))}catch{}function e(){const c=document.documentElement.classList.toggle("dark");document.body.classList.toggle("dark",c);try{localStorage.setItem("ft_theme",c?"dark":"light")}catch{}r.textContent=c?"Light":"Dark"}const r=document.createElement("button");r.className="theme-toggle",r.textContent=document.documentElement.classList.contains("dark")?"Light":"Dark",r.addEventListener("click",e),document.addEventListener("DOMContentLoaded",()=>document.body.appendChild(r))})();
