import{f as y}from"./api-Cdk2p__r.js";import{i as S}from"./navigation-BDLIzq93.js";import{i as b,l as D}from"./profile-BEROGLl0.js";import{r as v,a as N}from"./charts-B9MTxP37.js";const R={USD:{USD:1,EUR:.94,PLN:4.5,RUB:90},EUR:{USD:1.06,EUR:1,PLN:4.8,RUB:95},PLN:{USD:.22,EUR:.21,PLN:1,RUB:20},RUB:{USD:.011,EUR:.0105,PLN:.05,RUB:1}};function k(){const t=D();return t.reportCurrency||t.currency||"USD"}function P(){const t=D();return t.balanceCurrency||t.reportCurrency||t.currency||"USD"}function f(t,c,n){if(c===n)return Number(t)||0;const r=R[c];return r&&r[n]?Number(t)*r[n]:Number(t)||0}async function w(){try{if(!localStorage.getItem("user")){window.location.href="login.html";return}}catch{}const t=await y("/api/transactions"),c=await y("/api/categories"),n=k(),r=P(),l=new Map;t.forEach(e=>{if(e.type==="expense"){const a=c.find(L=>L.id===e.category_id),o=a?a.name:"Неизвестно",s=l.get(o)||0,d=f(Number(e.amount),e.currency||"USD",n);l.set(o,s+d)}});const g=Array.from(l.keys()),E=Array.from(l.values());document.getElementById("expenseChart")&&await v("expenseChart",g,E,n),document.getElementById("expensePie")&&await N("expensePie",g,E,n);const m=document.getElementById("topCategories");if(m){const e=Array.from(l.entries()).sort((o,s)=>s[1]-o[1]);if(m.innerHTML="",e.slice(0,5).forEach(([o,s])=>{const d=document.createElement("li");d.textContent=`${o}: ${s.toFixed(2)} ${n}`,m.appendChild(d)}),!e.length){const o=document.createElement("li");o.textContent="Нет данных",m.appendChild(o)}}let i=0,u=0;t.forEach(e=>{const a=f(Number(e.amount),e.currency||"USD",r);e.type==="income"?i+=a:e.type==="expense"&&(u+=a)});const h=document.getElementById("totalBalance"),p=document.getElementById("totalIncome"),x=document.getElementById("totalExpense");h&&(h.textContent=(i-u).toFixed(2)),p&&(p.textContent=i.toFixed(2)),x&&(x.textContent=u.toFixed(2));try{document.querySelectorAll(".currency-code").forEach(e=>{e.textContent=r})}catch{}const C=i>0?Math.max((i-u)/i,0):0,I=document.getElementById("financialHealth"),U=document.getElementById("healthProgress");I&&(I.textContent=(C*100).toFixed(0)+"%"),U&&(U.style.width=(C*100).toFixed(0)+"%");try{const e=await y("/api/forecast"),a=document.getElementById("aiIncome"),o=document.getElementById("aiExpense");if(e&&a&&o){const s=f(Number(e.predicted_income||0),"USD",r),d=f(Number(e.predicted_expense||0),"USD",r);a.textContent=s.toFixed(2),o.textContent=d.toFixed(2)}}catch(e){console.error("Ошибка загрузки AI‑прогноза",e)}}S();b();const B=()=>{document.getElementById("expenseChart")&&w()};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",B):B();(function(){if(document.querySelector(".theme-toggle"))return;try{localStorage.getItem("ft_theme")==="dark"&&(document.documentElement.classList.add("dark"),document.body.classList.add("dark"))}catch{}function t(){const n=document.documentElement.classList.toggle("dark");document.body.classList.toggle("dark",n);try{localStorage.setItem("ft_theme",n?"dark":"light")}catch{}c.textContent=n?"Light":"Dark"}const c=document.createElement("button");c.className="theme-toggle",c.textContent=document.documentElement.classList.contains("dark")?"Light":"Dark",c.addEventListener("click",t),document.addEventListener("DOMContentLoaded",()=>document.body.appendChild(c))})();
