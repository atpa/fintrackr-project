import{i as S,f as T}from"./profile-DStBtrFs.js";import{i as V}from"./navigation-BDLIzq93.js";V();S();function x(C,d,p,v){p.innerHTML="",C.forEach(e=>{const f=document.createElement("tr"),a=d.find(y=>y.id===e.category_id),o=document.createElement("td");o.textContent=a?a.name:"—";const g=document.createElement("td");g.textContent=e.month;const s=document.createElement("td"),m=document.createElement("td"),l=document.createElement("td");let u,i=Number(e.limit)||0;const n=e.currency||"USD";if(e.type==="percent"&&e.percent!=null){let y=0;Array.isArray(v)&&v.forEach(b=>{if(b.type==="income"){const B=new Date(b.date);if(B.getFullYear()+"-"+String(B.getMonth()+1).padStart(2,"0")===e.month){const N=typeof convertAmount=="function"?convertAmount(Number(b.amount),b.currency||"USD",n):Number(b.amount);y+=N}}}),i=y*(Number(e.percent)/100);const E=typeof formatCurrency=="function"?formatCurrency(i,n):`${i.toFixed(2)} ${n}`;u=`${Number(e.percent).toFixed(1)}% (${E})`}else u=typeof formatCurrency=="function"?formatCurrency(e.limit,n):`${Number(e.limit).toFixed(2)} ${n}`;s.textContent=u;const r=typeof formatCurrency=="function"?formatCurrency(e.spent,n):`${Number(e.spent).toFixed(2)} ${n}`;m.textContent=r;const h=i>0?Math.min(100,Number(e.spent)/i*100):0,t=document.createElement("div");t.style.backgroundColor="#e2e8f0",t.style.borderRadius="4px",t.style.height="12px",t.style.width="100%";const c=document.createElement("div");c.style.height="100%",c.style.borderRadius="4px",c.style.width=h+"%",c.style.backgroundColor=h>100?"var(--danger)":"var(--primary)",t.appendChild(c),l.appendChild(t),f.append(o,g,s,m,l),p.appendChild(f)})}async function I(){const C=document.querySelector("#budgetsTable tbody");if(!C)return;const[d,p,v]=await Promise.all([T("/api/budgets"),T("/api/categories"),T("/api/transactions")]);x(d,p,C,v);const e=document.getElementById("budgetCategory");e&&(e.innerHTML="",p.forEach(a=>{const o=document.createElement("option");o.value=a.id,o.textContent=a.name,e.appendChild(o)}));const f=document.getElementById("addBudgetForm");if(f){const a=document.getElementById("budgetType"),o=document.getElementById("limitContainer"),g=document.getElementById("percentContainer");if(a&&o&&g){const s=()=>{a.value==="percent"?(g.style.display="",o.style.display="none"):(g.style.display="none",o.style.display="")};a.addEventListener("change",s),s()}f.addEventListener("submit",async s=>{var h;s.preventDefault();const m=document.getElementById("budgetCategory"),l=document.getElementById("budgetMonth"),u=document.getElementById("budgetType"),i=document.getElementById("budgetLimit"),n=document.getElementById("budgetPercent"),r={category_id:Number(m.value),month:l.value,limit:parseFloat(i.value),type:(u==null?void 0:u.value)||"fixed",percent:n!=null&&n.value?parseFloat(n.value):null,currency:((h=document.getElementById("budgetCurrency"))==null?void 0:h.value)||"USD"};if(!r.month){l.setCustomValidity("Выберите месяц"),l.reportValidity(),setTimeout(()=>l.setCustomValidity(""),1500);return}if(!r.category_id){m.setCustomValidity("Выберите категорию"),m.reportValidity(),setTimeout(()=>m.setCustomValidity(""),1500);return}if(r.type==="percent"){const t=Number(r.percent);if(!isFinite(t)||t<0||t>100){n.setCustomValidity("Процент должен быть числом от 0 до 100"),n.reportValidity(),setTimeout(()=>n.setCustomValidity(""),1500);return}r.limit=0}else{const t=Number(r.limit);if(!isFinite(t)||t<0){i.setCustomValidity("Лимит должен быть числом 0 или больше"),i.reportValidity(),setTimeout(()=>i.setCustomValidity(""),1500);return}r.percent=null}try{const t=await fetch("/api/budgets",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!t.ok){const E=await t.json();alert("Ошибка: "+(E.error||"не удалось сохранить бюджет"));return}const c=await t.json(),y=d.findIndex(E=>E.id===c.id);y!==-1?d[y]=c:d.push(c),x(d,p,C),f.reset()}catch(t){console.error(t),alert("Ошибка сети")}})}}document.readyState!=="loading"?I():document.addEventListener("DOMContentLoaded",I);
