import{i as e}from"./chunks/navigation-BNxy9xC7.js";import{i as t}from"./chunks/profile-BfLkpaKJ.js";import{A as n}from"./chunks/api-DDAYoQqf.js";import{t as o,a as r}from"./chunks/Toast-Cw3r9-oW.js";function i(e,t,n,o){n.innerHTML="",e.forEach(e=>{const r=document.createElement("tr"),i=t.find(t=>t.id===e.category_id),d=document.createElement("td");d.textContent=i?i.name:"—";const a=document.createElement("td");a.textContent=e.month;const u=document.createElement("td"),c=document.createElement("td"),m=document.createElement("td");let l,s=Number(e.limit)||0;const y=e.currency||"USD";if("percent"===e.type&&null!=e.percent){let t=0;Array.isArray(o)&&o.forEach(n=>{if("income"===n.type){const o=new Date(n.date);if(o.getFullYear()+"-"+String(o.getMonth()+1).padStart(2,"0")===e.month){const e="function"==typeof convertAmount?convertAmount(Number(n.amount),n.currency||"USD",y):Number(n.amount);t+=e}}}),s=t*(Number(e.percent)/100);const n="function"==typeof formatCurrency?formatCurrency(s,y):`${s.toFixed(2)} ${y}`;l=`${Number(e.percent).toFixed(1)}% (${n})`}else l="function"==typeof formatCurrency?formatCurrency(e.limit,y):`${Number(e.limit).toFixed(2)} ${y}`;u.textContent=l;const p="function"==typeof formatCurrency?formatCurrency(e.spent,y):`${Number(e.spent).toFixed(2)} ${y}`;c.textContent=p;const g=s>0?Math.min(100,Number(e.spent)/s*100):0,f=document.createElement("div");f.style.backgroundColor="#e2e8f0",f.style.borderRadius="4px",f.style.height="12px",f.style.width="100%";const C=document.createElement("div");C.style.height="100%",C.style.borderRadius="4px",C.style.width=g+"%",C.style.backgroundColor=g>100?"var(--danger)":"var(--primary)",f.appendChild(C),m.appendChild(f),r.append(d,a,u,c,m),n.appendChild(r)})}async function d(){const e=document.querySelector("#budgetsTable tbody");if(e)try{const[t,d,a]=await Promise.all([n.budgets.getAll(),n.categories.getAll(),n.transactions.getAll()]);i(t,d,e,a);const u=document.getElementById("budgetCategory");u&&(u.innerHTML="",d.forEach(e=>{const t=document.createElement("option");t.value=e.id,t.textContent=e.name,u.appendChild(t)}));const c=document.getElementById("addBudgetForm");if(c){const u=document.getElementById("budgetType"),m=document.getElementById("limitContainer"),l=document.getElementById("percentContainer");if(u&&m&&l){const e=()=>{"percent"===u.value?(l.style.display="",m.style.display="none"):(l.style.display="none",m.style.display="")};u.addEventListener("change",e),e()}c.addEventListener("submit",async u=>{var m;u.preventDefault();const l=document.getElementById("budgetCategory"),s=document.getElementById("budgetMonth"),y=document.getElementById("budgetType"),p=document.getElementById("budgetLimit"),g=document.getElementById("budgetPercent"),f={category_id:Number(l.value),month:s.value,limit:parseFloat(p.value),type:(null==y?void 0:y.value)||"fixed",percent:(null==g?void 0:g.value)?parseFloat(g.value):null,currency:(null==(m=document.getElementById("budgetCurrency"))?void 0:m.value)||"USD"};if(!f.month)return s.setCustomValidity("Выберите месяц"),s.reportValidity(),void setTimeout(()=>s.setCustomValidity(""),1500);if(!f.category_id)return l.setCustomValidity("Выберите категорию"),l.reportValidity(),void setTimeout(()=>l.setCustomValidity(""),1500);if("percent"===f.type){const e=Number(f.percent);if(!isFinite(e)||e<0||e>100)return g.setCustomValidity("Процент должен быть числом от 0 до 100"),g.reportValidity(),void setTimeout(()=>g.setCustomValidity(""),1500);f.limit=0}else{const e=Number(f.limit);if(!isFinite(e)||e<0)return p.setCustomValidity("Лимит должен быть числом 0 или больше"),p.reportValidity(),void setTimeout(()=>p.setCustomValidity(""),1500);f.percent=null}try{const r=await n.budgets.create(f),u=t.findIndex(e=>e.id===r.id);-1!==u?(t[u]=r,o("Бюджет обновлён!")):(t.push(r),o("Бюджет создан!")),i(t,d,e,a),c.reset()}catch(C){r(`Не удалось сохранить бюджет: ${C.message}`)}})}}catch(t){r(`Не удалось загрузить данные: ${t.message}`)}}e(),t(),"loading"!==document.readyState?d():document.addEventListener("DOMContentLoaded",d);
