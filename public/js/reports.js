import{i as D,f as b}from"./profile-DStBtrFs.js";import{i as R}from"./navigation-BDLIzq93.js";import{r as L,a as $}from"./charts-B9MTxP37.js";R();D();function M(s,p){const u=new Map;return s.forEach(e=>{if(e.type==="expense"){const a=p.find(r=>r.id===e.category_id),i=a?a.name:"Неизвестно",l=u.get(i)||0,d=typeof getReportCurrency=="function"?getReportCurrency():"USD",m=typeof convertAmount=="function"?convertAmount(Number(e.amount),e.currency||"USD",d):Number(e.amount);u.set(i,l+m)}}),u}async function B(){const s=document.getElementById("reportPeriod").value,p=document.getElementById("reportMonth"),u=document.getElementById("reportYear"),[e,a]=await Promise.all([b("/api/transactions"),b("/api/categories")]),i=e.filter(t=>{const n=new Date(t.date);if(s==="month"){const o=p.value;if(!o)return!1;const[f,c]=o.split("-").map(Number);return n.getFullYear()===f&&n.getMonth()+1===c}else{const o=parseInt(u.value,10);return o?n.getFullYear()===o:!1}}),l=M(i,a),d=Array.from(l.keys()),m=Array.from(l.values()),r=[],y=[],v=d.map((t,n)=>({label:t,value:m[n]}));v.sort((t,n)=>n.value-t.value);let g=0;v.forEach((t,n)=>{n<8?(r.push(t.label),y.push(t.value)):g+=t.value}),g>0&&(r.push("Другие"),y.push(g));const E=typeof getReportCurrency=="function"?getReportCurrency():"USD";document.getElementById("reportChart")&&await L("reportChart",r,y,E),document.getElementById("reportPie")&&await $("reportPie",r,y,E);const I=document.getElementById("reportSummary");if(I){let t=0,n=0;i.forEach(c=>{const h=typeof getReportCurrency=="function"?getReportCurrency():"USD",C=typeof convertAmount=="function"?convertAmount(Number(c.amount),c.currency||"USD",h):Number(c.amount);c.type==="income"?t+=C:c.type==="expense"&&(n+=C)});let o="";const f=typeof getReportCurrency=="function"?getReportCurrency():"USD";if(o+=`<p><strong>Суммарный доход:</strong> ${t.toFixed(2)} ${f}</p>`,o+=`<p><strong>Суммарный расход:</strong> ${n.toFixed(2)} ${f}</p>`,r.length>0){const c=r[0],h=y[0];o+=`<p><strong>Наибольшие расходы:</strong> категория "${c}" — ${h.toFixed(2)} ${f}</p>`}s==="month"?o+="<p>AI‑отчёт: в этом месяце ваши расходы распределены по категориям, как показано на диаграмме. Обратите внимание на категории с наибольшими тратами.</p>":o+="<p>AI‑отчёт: в этом году основные траты приходятся на показанные категории. Анализируйте ваши расходы, чтобы лучше планировать бюджет.</p>",I.innerHTML=o}}async function S(){const s=document.getElementById("reportPeriod"),p=document.getElementById("reportMonth"),u=document.getElementById("reportYear"),e=document.getElementById("reportMonthLabel"),a=document.getElementById("reportYearLabel"),i=new Date,l=i.getFullYear(),d=String(i.getMonth()+1).padStart(2,"0");p&&(p.value=`${l}-${d}`),u&&(u.value=`${l}`),s&&s.addEventListener("change",()=>{s.value==="month"?(e&&(e.style.display=""),a&&(a.style.display="none")):(e&&(e.style.display="none"),a&&(a.style.display=""))});const m=document.getElementById("generateReport");m&&m.addEventListener("click",r=>{r.preventDefault(),B()}),B()}document.readyState!=="loading"?S():document.addEventListener("DOMContentLoaded",S);
